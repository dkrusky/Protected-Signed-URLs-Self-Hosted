{"name":"Protected & Signed urls (self-hosted)","tagline":"Self hosted signed url's for protecting downloads, similar to Amazon S3 .","body":"# Protected-Signed-URLs-Self-Hosted\r\nSelf hosted signed url's for protecting downloads, similar to Amazon S3 .\r\n\r\n### Introduction\r\n\r\nThis project is a drop-in solution for those wishing to have links that expire without incurring the additional unknown surcharge most content delivery networks charge for this service. I started this project as a result of being unable to use Amazons own signing method to create signed links to content on Amazon CloudFront using a CNAME and their free offering of SSL certificates. While this seemed like a great idea at the time, there was a lot of pain involved in sifting through their various API documentation, php libraries, and many hours getting trolled by Google search results on the topic including bucket permissions, cloudfront permissions, OAI, policies, groups, users, all resulting in the same thing that even popular software which Amazon touts somewhere in their api documentation, was a complete waste of time as nothing would generate the links.\r\n\r\nAfter coming to my senses, I decided to call it quits with Amazton CloudFront (and thus s3) and write my own method which uses similar policy-style signing of URL's using a private/public key in the form of certificates to sign and validate the signing. The next problem I faced, was how to deliver large files without consuming all the memory in the system due to the way an `fread()` - `echo` loop would work.  That is when I remember XSendFile, an Apache module that does exactly that.\r\n\r\n\r\n### System Requirements\r\n- mod_rewrite\r\n- xsendfile\r\n- php 5.4+\r\n- openssl (may work with other compatible libs but is untested)\r\n\r\n### Installation Instructions\r\n\r\nThese instructions assume that the system requirements have been met, are installed, and enabled.\r\n\r\n#### Server Configuration\r\n\r\nIn your websites main configuration file, ensure that the following variables have been set for your specific website. For the purpose of simplifying the documentation, we will use `/var/www/html/downloads/` as the path where you have this script installed, and `/var/www/html/` is the server location of your websites root folder.\r\n\r\n| Parameter | Value |\r\n| --- | --- |\r\n|XSendFile|on|\r\n|XSendFilePath|/var/www/html/downloads/|\r\n\r\nFor Apache, you will want to create a new `.htaccess` file in `/var/www/html/downloads/` and paste the following into it:\r\n\r\n```apacheconf\r\nOptions -Indexes\r\n<IfModule mod_headers.c>\r\n\tHeader Always set Cache-Control \"max-age=0, no-cache, no-store, must-revalidate\"\r\n\tHeader Always set Pragma \"no-cache\"\r\n</IfModule>\r\n<IfModule mod_rewrite.c>\r\n\tRewriteEngine On\r\n\tRewriteRule ^protected.php - [QSA,L]\r\n\tRewriteRule ^(.*)$ ./protected.php [QSA,L]\r\n</IfModule>\r\n```\r\n\r\n#### Generating the Private/Public key pair\r\n\r\nBy default, there is a private/public key pair included in the source as the define values for `PRIVATE_KEY` and `PUBLIC_KEY` which server no other purpose than to demonstrate the location this information will go, and to provide a quick way to 'test' the suitability of this project for those who have already been through the endless cesspool of broken/defunct projects without wasting too much more time.\r\n\r\n**_DO NOT USE THE INCLUDED PRIVATE/PUBLIC KEY IN PRODUCTION_**\r\n\r\nGenerate the Private key (it will prompt for a password)\r\n```sh\r\nopenssl genrsa -des3 -out PRIVATE_KEY.pem 2048\r\n```\r\n\r\nRemove the password from the Private key (it will prompt for the password you used when generating the private key)\r\n```sh\r\nopenssl genrsa -des3 -out PRIVATE_KEY.pem 2048\r\n```\r\n\r\n**_As always, it is important that you keep your private keys: Private !!!_**\r\n\r\n\r\nGenerate the Public key\r\n```\r\nopenssl rsa -in PRIVATE_KEY.pem -outform PEM -pubout -out PUBLIC_KEY.pem\r\n```\r\n\r\nThe entire contents of the files are their respective defines in `config.inc.php`.  For example:\r\n\r\n```php\r\n\tdefine('PUBLIC_KEY', '-----BEGIN PUBLIC KEY-----\r\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAx6ux0PNiW6QcKqtXxjQJ\r\nQrv0D4hLkoHdLzNuwvxSQpwF7YkZ1E7DfGsDUV0hZkc2vuIKIq1wBL/q5BL4lqH2\r\nfxotBI9VJf7ldYVqywk/5lEDymxog7DmQhUid688xbUCtUUBbZ88jY1x+/rhgf7w\r\nwHuV95X5Z5dGwXdO8z64DjWqgb8wPIiMHuCxm9/KMm3O9fzrzC80oHzXMmJRZ/tP\r\np2odV6xQh5Y3TkzFn6quod5loTiSsN1Ue9n9QqPVlQJD9yKiAfeg+YdRMfuYI1Vw\r\n4cJ+r2iKAuNs+GtQOW3b1VV8hPQeMSwWShMq8YTm7IAaUaLGEwfMOuBW06OeV+i9\r\n1wIDAQAB\r\n-----END PUBLIC KEY-----');\r\n```\r\n\r\n... is the define for `PUBLIC_KEY.pem`\r\n\r\n_NOTE:_ You can place the `PUBLIC_KEY.pem`, and `PRIVATE_KEY.pem` inside the same folder where the script is installed and it will automatically detect them and use them, eliminating the need for the `config.inc.php`. The recommended approach is to embed them directly in the `config.inc.php` file,\r\n\r\n#### Where do you put your files ?\r\n\r\nOn the server of course !!!  While there are many solutions that require you to host the files in some obscure location, this does not require any such tactics to be involved due to the way that the files are rendered inaccessible directly through mod_rewrite.\r\n\r\nThe only requirement in this regard, is that the files are located in the same folder where this script is installed, and that the `XSendFilePath` as outlined in the **Server Configuration** step is pointed to the right folder. If using multiple installations of this script, then you can simply point XSendFilePath to the base folder of your website.\r\n\r\n#### Generating a Signed Link\r\n\r\n**sign( url , expires)**\r\n\r\n|Parameter|Description|\r\n|---|---|\r\n|url|The url to sign. This must be a resource that is protected on your server. The script will generate a signed link for any url, however it can only validate and serve content where it is installed.|\r\n|expires|The time (in minutes) for how long the generated link should be valid for|\r\n\r\n_Returns_\r\n\r\n|type|result|\r\n|---|---|\r\n|string|Full url with attached query string parameters for the time the link expires, and the hash/signature.|\r\n\r\n```php\r\ndefine('URLSIGNINCLUDE', true);\r\nrequire('/path/to/protected.php');\r\n\r\n$link = URLSigner::sign( 'https://www.foo.com/downloads/protectedfile.zip', 10 );\r\n```\r\n\r\n#### Verifying a Signed Link\r\n\r\n**verify( url )**\r\n\r\n|Parameter|Description|\r\n|---|---|\r\n|url|The full url to verify, including all attached query parameters, scheme, and path. Example: `https://www.foo.com/downloads/protectedfile.zip?Expires=1234567&Hash=12345678...`|\r\n\r\n_Returns_\r\n\r\n|type|result|\r\n|---|---|\r\n|boolean|true if signature is valid and expires value hasn't elapsed|\r\n\r\n```php\r\ndefine('URLSIGNINCLUDE', true);\r\nrequire('/path/to/protected.php');\r\n\r\n$bool = URLSigner::verify( 'https://www.foo.com/downloads/protectedfile.zip?Expires=1234567&Hash=12345678...' );\r\nif($bool === false) {\r\n\techo 'Valid Link';\r\n} else {\r\n\techo 'Invalid Link';\r\n}\r\n```\r\n","google":"UA-3935915-2","note":"Don't delete this file! It's used internally to help with page regeneration."}